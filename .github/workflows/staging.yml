name: Staging Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: staging-deployment
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------
  # PRE-FLIGHT
  # ------------------------------------------------------------
  staging-preflight:
    name: Staging Preflight â€“ ECS Stability Check
    runs-on: ubuntu-latest
    environment: staging

    permissions:
      id-token: write
      contents: read

    env:
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      ECS_SERVICE: ${{ vars.ECS_SERVICE }}
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECS service stability
        shell: bash
        run: |
          MAX_WAIT_SECONDS=600
          SLEEP_SECONDS=30
          ELAPSED=0

          while true; do
            STATUS=$(aws ecs describe-services \
              --cluster "$ECS_CLUSTER" \
              --services "$ECS_SERVICE" \
              --query 'services[0].deployments' \
              --output json)

            DEPLOYMENT_COUNT=$(echo "$STATUS" | jq length)

            if [ "$DEPLOYMENT_COUNT" -eq 1 ]; then
              ROLLOUT_STATE=$(aws ecs describe-services \
                --cluster "$ECS_CLUSTER" \
                --services "$ECS_SERVICE" \
                --query 'services[0].deployments[0].rolloutState' \
                --output text)

              if [ "$ROLLOUT_STATE" = "COMPLETED" ]; then
                exit 0
              fi
            fi

            if [ "$ELAPSED" -ge "$MAX_WAIT_SECONDS" ]; then
              exit 1
            fi

            sleep "$SLEEP_SECONDS"
            ELAPSED=$((ELAPSED + SLEEP_SECONDS))
          done

  # ------------------------------------------------------------
  # BUILD WEB (PARALLEL)
  # ------------------------------------------------------------
  build-web-staging:
    name: Build & Push Web Container
    runs-on: ubuntu-latest
    environment: staging
    needs: staging-preflight

    permissions:
      id-token: write
      contents: read

    outputs:
      web_image: ${{ steps.image.outputs.web_image }}

    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - id: tag
        run: echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - id: image
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY"

          docker build -t "$ECR_REPOSITORY:$TAG" .
          docker tag "$ECR_REPOSITORY:$TAG" "$ECR_URI:$TAG"
          docker push "$ECR_URI:$TAG"

          echo "web_image=$ECR_URI:$TAG" >> "$GITHUB_OUTPUT"

  # ------------------------------------------------------------
  # BUILD WORKER (PARALLEL)
  # ------------------------------------------------------------
  build-worker-staging:
    name: Build & Push Worker Container
    runs-on: ubuntu-latest
    environment: staging
    needs: staging-preflight

    permissions:
      id-token: write
      contents: read

    outputs:
      worker_image: ${{ steps.image.outputs.worker_image }}

    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - id: tag
        run: echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - id: image
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY"

          docker build -f workers/Dockerfile -t "$ECR_REPOSITORY:$TAG-worker" .
          docker tag "$ECR_REPOSITORY:$TAG-worker" "$ECR_URI:$TAG-worker"
          docker push "$ECR_URI:$TAG-worker"

          echo "worker_image=$ECR_URI:$TAG-worker" >> "$GITHUB_OUTPUT"

  # ------------------------------------------------------------
  # BUILD FAN-IN
  # ------------------------------------------------------------
  build-and-push-staging:
    name: Build & Push Staging Containers
    runs-on: ubuntu-latest
    needs:
      - build-web-staging
      - build-worker-staging

    outputs:
      web_image: ${{ needs.build-web-staging.outputs.web_image }}
      worker_image: ${{ needs.build-worker-staging.outputs.worker_image }}

    steps:
      - run: echo "Build complete"

  # ------------------------------------------------------------
  # DEPLOY
  # ------------------------------------------------------------
  deploy-staging:
    name: Deploy to Staging ECS
    runs-on: ubuntu-latest
    environment: staging
    needs: build-and-push-staging

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: us-east-1
      WEB_IMAGE: ${{ needs.build-and-push-staging.outputs.web_image }}
      WORKER_IMAGE: ${{ needs.build-and-push-staging.outputs.worker_image }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}

      - name: Deploy web service to staging
        run: |
          set -Eeuo pipefail

          cluster="${{ vars.ECS_CLUSTER }}"
          service="${{ vars.ECS_SERVICE }}"
          container="${{ vars.ECS_CONTAINER_NAME }}"
          image="$WEB_IMAGE"

          rollback() {
            echo "âš ï¸ Deployment failed. Rolling back web service..."
            aws ecs update-service \
              --cluster "$cluster" \
              --service "$service" \
              --task-definition "$OLD_TD_ARN"

            aws ecs wait services-stable \
              --cluster "$cluster" \
              --services "$service"

            echo "ğŸ”™ Web service rolled back to $OLD_TD_ARN"
          }

          trap rollback ERR

          echo "ğŸš€ Deploying web image: $image"

          OLD_TD_ARN=$(aws ecs describe-services \
            --cluster "$cluster" \
            --services "$service" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$OLD_TD_ARN" \
            --query taskDefinition > td-web.json

          jq --arg img "$image" --arg name "$container" '
            .containerDefinitions |= map(
              if .name == $name then .image = $img else . end
            )
            | del(
                .revision,
                .status,
                .taskDefinitionArn,
                .requiresAttributes,
                .compatibilities,
                .registeredAt,
                .registeredBy
              )
          ' td-web.json > td-web-register.json

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://td-web-register.json \
            --query taskDefinition.taskDefinitionArn \
            --output text)

          aws ecs update-service \
            --cluster "$cluster" \
            --service "$service" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$cluster" \
            --services "$service"

          trap - ERR
          echo "âœ… Web service deployed successfully"

      - name: Deploy worker service to staging
        run: |
          set -Eeuo pipefail

          cluster="${{ vars.ECS_WORKER_CLUSTER }}"
          service="${{ vars.ECS_WORKER_SERVICE }}"
          container="${{ vars.ECS_WORKER_CONTAINER_NAME }}"
          image="$WORKER_IMAGE"

          rollback() {
            echo "âš ï¸ Deployment failed. Rolling back worker service..."
            aws ecs update-service \
              --cluster "$cluster" \
              --service "$service" \
              --task-definition "$OLD_TD_ARN"

            aws ecs wait services-stable \
              --cluster "$cluster" \
              --services "$service"

            echo "ğŸ”™ Worker service rolled back to $OLD_TD_ARN"
          }

          trap rollback ERR

          echo "ğŸš€ Deploying worker image: $image"

          OLD_TD_ARN=$(aws ecs describe-services \
            --cluster "$cluster" \
            --services "$service" \
            --query "services[0].taskDefinition" \
            --output text)

          aws ecs describe-task-definition \
            --task-definition "$OLD_TD_ARN" \
            --query taskDefinition > td-worker.json

          jq --arg img "$image" --arg name "$container" '
            .containerDefinitions |= map(
              if .name == $name then .image = $img else . end
            )
            | del(
                .revision,
                .status,
                .taskDefinitionArn,
                .requiresAttributes,
                .compatibilities,
                .registeredAt,
                .registeredBy
              )
          ' td-worker.json > td-worker-register.json

          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://td-worker-register.json \
            --query taskDefinition.taskDefinitionArn \
            --output text)

          aws ecs update-service \
            --cluster "$cluster" \
            --service "$service" \
            --task-definition "$NEW_TD_ARN"

          aws ecs wait services-stable \
            --cluster "$cluster" \
            --services "$service"

          trap - ERR
          echo "âœ… Worker service deployed successfully"

      - name: Publish staging access links
        if: success()
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ğŸš€ Staging Deployment Complete

          **Environment:** Staging  
          **Status:** âœ… Healthy

          ### ğŸ”— Application Links
          - ğŸŒ **Web App:** https://staging.app.nationaltutoringobservatory.org/

          ### ğŸ³ Deployed Images
          - **Web:** \`${{ env.WEB_IMAGE }}\`
          - **Worker:** \`${{ env.WORKER_IMAGE }}\`

          ---
          _Tip: Bookmark the staging URL for quick testing._
          EOF
